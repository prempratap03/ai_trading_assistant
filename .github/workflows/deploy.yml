- name: SSH into EC2 and build + run container
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: 13.203.78.90 
    username: ubuntu
    key: ${{ secrets.EC2_SSH_KEY }}
    script_stop: true
    command_timeout: 40m
    script: |
      set -euxo pipefail
      
      # Clean up Docker resources
      sudo docker system prune -af --volumes
      
      # Clean up apt cache
      sudo apt-get clean
      sudo rm -rf /var/lib/apt/lists/*
      
      # Remove old images more aggressively
      sudo docker rmi $(sudo docker images -q) 2>/dev/null || true
      
      # Clean pip cache
      rm -rf ~/.cache/pip
      
      # Check available space
      df -h
      
      cd ~/ai_trading_assistant || git clone https://github.com/prempratap03/ai_trading_assistant.git ~/ai_trading_assistant
      cd ~/ai_trading_assistant
      git pull origin main
      
      echo "ðŸ³ Building image on EC2..."
      sudo docker build -t ai_trading_assistant .
      
      echo "ðŸš€ Running container on port 80..."
      sudo docker stop ai-trading 2>/dev/null || true
      sudo docker rm ai-trading 2>/dev/null || true
      sudo docker run -d --name ai-trading -p 80:8501 \
        -e RAPIDAPI_KEY='${{ secrets.RAPIDAPI_KEY }}' \
        ai_trading_assistant