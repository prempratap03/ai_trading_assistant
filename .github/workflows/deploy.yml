- name: SSH into EC2 and build + run container
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: 13.203.78.90 
    username: ubuntu
    key: ${{ secrets.EC2_SSH_KEY }}
    script_stop: true
    command_timeout: 40m
    script: |
      set -euxo pipefail
      
      echo "ğŸ’¾ Ensuring swap space is active..."
      # Check if swapfile exists and activate it
      if [ -f /swapfile ]; then
        sudo swapon /swapfile 2>/dev/null || echo "Swap already active"
      else
        # Create swap if it doesn't exist
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
      fi
      
      echo "ğŸ“Š Memory status:"
      free -h
      
      echo "ğŸ§¹ Cleaning up Docker..."
      # Stop and remove old container
      if sudo docker ps -a | grep -q ai-trading; then
        sudo docker stop ai-trading || true
        sudo docker rm ai-trading || true
      fi
      
      # Clean Docker resources
      sudo docker system prune -af --volumes
      sudo docker builder prune -af
      
      # Remove all images
      if [ "$(sudo docker images -q)" ]; then
        sudo docker rmi -f $(sudo docker images -aq)
      fi
      
      # Clean system caches
      sudo apt-get clean
      sudo rm -rf /var/lib/apt/lists/* /tmp/* ~/.cache
      
      echo "ğŸ“Š Disk space:"
      df -h
      
      # Update repo
      if [ ! -d ~/ai_trading_assistant ]; then
        git clone https://github.com/prempratap03/ai_trading_assistant.git ~/ai_trading_assistant
      fi
      
      cd ~/ai_trading_assistant
      git pull origin main
      
      # Build with BuildKit
      echo "ğŸ³ Building Docker image..."
      export DOCKER_BUILDKIT=1
      sudo DOCKER_BUILDKIT=1 docker build \
        --progress=plain \
        -t ai_trading_assistant .
      
      # Clean up after build
      sudo docker builder prune -f
      
      echo "ğŸ“Š Memory after build:"
      free -h
      
      echo "ğŸš€ Starting container..."
      sudo docker run -d --name ai-trading -p 80:8501 \
        --memory="700m" \
        --memory-swap="1g" \
        -e RAPIDAPI_KEY='${{ secrets.RAPIDAPI_KEY }}' \
        ai_trading_assistant
      
      echo "âœ… Deployment complete!"
      sudo docker ps
      sudo docker logs ai-trading --tail 50