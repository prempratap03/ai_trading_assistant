name: Deploy to EC2 with Self-Hosted Runner
on:
  push:
    branches:
      - main
      
jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check resources
        run: |
          echo "ðŸ“Š Disk Space:"
          df -h
          echo ""
          echo "ðŸ“Š Memory:"
          free -h
      
      - name: Activate swap
        run: |
          sudo swapon /swapfile 2>/dev/null || echo "Swap already active"
          free -h
      
      - name: Clean Docker
        run: |
          sudo docker stop ai-trading 2>/dev/null || true
          sudo docker rm ai-trading 2>/dev/null || true
          sudo docker system prune -af --volumes
          sudo docker builder prune -af
      
      - name: Build Docker image
        run: |
          export DOCKER_BUILDKIT=1
          sudo DOCKER_BUILDKIT=1 docker build -t ai_trading_assistant .
      
      - name: Start container
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        run: |
          sudo docker run -d --name ai-trading -p 80:8501 \
            --memory="700m" \
            --memory-swap="1g" \
            -e RAPIDAPI_KEY="${RAPIDAPI_KEY}" \
            ai_trading_assistant
      
      - name: Verify deployment
        run: |
          echo "âœ… Deployment complete!"
          sudo docker ps
          sleep 5
          sudo docker logs ai-trading --tail 50
      
      - name: Cleanup
        if: always()
        run: |
          sudo docker system prune -f